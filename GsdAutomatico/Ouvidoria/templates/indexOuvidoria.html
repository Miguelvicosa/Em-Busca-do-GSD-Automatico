{% extends 'base.html' %}
{% load static %} {# Certifique-se que load static está presente #}

{% block title %}Analisador de Documentos{% endblock %}

{% block content %}
<style>
    /* Estilos (permanecem os mesmos da sua versão) */
    .analisador-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start; }
    @media (max-width: 992px) { .analisador-grid { grid-template-columns: 1fr; } }
    .upload-form .file-label { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-height: 200px; padding: 20px; border-radius: 8px; border: 2px dashed var(--border-color); box-sizing: border-box; margin-bottom: 15px; text-align: center; cursor: pointer; color: var(--text-secondary); transition: border-color 0.3s, background-color 0.3s; }
    .upload-form .file-label svg { width: 48px; height: 48px; margin-bottom: 15px; color: var(--accent-color); }
    .upload-form .file-label:hover { border-color: var(--accent-color); background-color: var(--sidebar-active-bg); }
    .upload-form button { width: 100%; padding: 15px; background-color: var(--accent-color); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .upload-form button:hover { background-color: var(--accent-hover); }
    .upload-form button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
    .upload-form button .spinner { width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .analise-box { border: 1px solid var(--border-color); padding: 25px; border-radius: 8px; background-color: var(--bg-content); min-height: 280px; display: flex; flex-direction: column; }
    .analise-box h3 { margin-top: 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .analise-resultado p, .militar-nao-encontrado p { margin: 12px 0; font-size: 16px; line-height: 1.7; }
    .analise-resultado strong { color: var(--text-primary); display: block; margin-bottom: 4px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
    .loading-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; flex-grow: 1; text-align: center; color: var(--text-secondary); }
    .loading-state .big-spinner { width: 40px; height: 40px; border: 4px solid var(--sidebar-active-bg); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    .prompt-actions { margin-top: 20px; display: flex; gap: 10px; }
    /* Adicionado para mensagens múltiplas */
    .resultado-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-color); }
    .resultado-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .alert { padding: 10px 15px; margin-bottom: 10px; border-radius: 6px; border: 1px solid transparent;}
    .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
    .alert-warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
    .alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
    .alert-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; } /* Estilo para erros no form dinâmico */
    .militar-nao-encontrado .form-grid { grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; } /* Ajuste grid form dinâmico */
    .militar-nao-encontrado .form-actions { margin-top: 15px; justify-content: flex-start;}
    /* --- Adicione isso ao seu bloco <style> --- */

    .search-wrapper {
        position: relative;
        width: 100%;
        margin-bottom: 15px;
    }

    .search-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23999' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z' /%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 18px;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.1); /* Ajuste conforme sua cor */
    }

    .search-results-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        display: none; /* Oculto por padrão */
        margin-top: 5px;
    }

    .search-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-item:last-child {
        border-bottom: none;
    }

    .search-item:hover {
        background-color: var(--sidebar-active-bg);
        color: var(--accent-color);
    }

    .search-item small {
        color: #888;
        font-size: 12px;
    }

    .divisor-ou {
        text-align: center;
        margin: 10px 0;
        font-size: 12px;
        color: #999;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
    }

    .divisor-ou::before, .divisor-ou::after {
        content: "";
        flex: 1;
        border-bottom: 1px solid var(--border-color);
    }
    .divisor-ou::before { margin-right: 10px; }
    .divisor-ou::after { margin-left: 10px; }
</style>

<h1>Analisador de Documentos</h1>
<p>Envie um PDF para extrair automaticamente as informações e criar uma PATD.</p>

<div class="analisador-grid" style="margin-top: 20px;">
    <div class="upload-column">
        <form id="analise-form" class="upload-form">
            {% csrf_token %}
            <label for="pdf_file_input" class="file-label" id="file-label">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 18.75a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                <span id="file-label-text">Clique ou arraste o ficheiro PDF</span>
            </label>
            <input type="file" name="pdf_file" id="pdf_file_input" accept=".pdf" required style="display: none;">
            <button type="button" id="submit-btn">
                <span class="spinner"></span>
                <span class="button-text">Analisar e Criar PATD</span>
            </button>
        </form>
    </div>
    <div class="resultado-column">
        <div class="analise-box" id="analise-box">
            <h3>Aguardando Documento</h3>
            <p>O resultado da análise e da criação da PATD aparecerá aqui.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('pdf_file_input');
    const fileLabel = document.getElementById('file-label');
    const fileLabelText = document.getElementById('file-label-text');
    const submitButton = document.getElementById('submit-btn');
    const analiseBox = document.getElementById('analise-box');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // --- Lógica de Upload e Drag & Drop ---
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                if (this.files[0].type === "application/pdf") {
                    fileLabelText.textContent = this.files[0].name;
                    fileLabel.style.borderColor = 'var(--border-color)';
                } else {
                    fileLabelText.textContent = 'Apenas ficheiros PDF são permitidos!';
                    fileLabel.style.borderColor = 'var(--danger-color)';
                    this.value = '';
                    setTimeout(() => {
                        fileLabel.style.borderColor = 'var(--border-color)';
                        if (!this.files || this.files.length === 0) {
                             fileLabelText.textContent = 'Clique ou arraste o ficheiro PDF';
                        }
                    }, 2000);
                }
            } else {
                fileLabelText.textContent = 'Clique ou arraste o ficheiro PDF';
                fileLabel.style.borderColor = 'var(--border-color)';
            }
        });
    }

    ['dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileLabel.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    fileLabel.addEventListener('dragover', (e) => {
        preventDefaults(e);
        fileLabel.style.borderColor = 'var(--accent-color)';
        fileLabel.style.backgroundColor = 'var(--sidebar-active-bg)';
    });

    fileLabel.addEventListener('dragleave', (e) => {
        preventDefaults(e);
        fileLabel.style.borderColor = 'var(--border-color)';
        fileLabel.style.backgroundColor = 'transparent';
    });

    fileLabel.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        preventDefaults(e);
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length) {
            if (files[0].type === "application/pdf") {
                fileInput.files = files;
                fileLabelText.textContent = files[0].name;
                fileLabel.style.borderColor = 'var(--success-color)';
            } else {
                fileLabelText.textContent = 'Apenas ficheiros PDF são permitidos!';
                fileLabel.style.borderColor = 'var(--danger-color)';
                fileInput.value = '';
            }
        }

        setTimeout(() => {
             fileLabel.style.borderColor = 'var(--border-color)';
             fileLabel.style.backgroundColor = 'transparent';
             if (!fileInput.files || fileInput.files.length === 0) {
                 fileLabelText.textContent = 'Clique ou arraste o ficheiro PDF';
             }
        }, 1500);
    }

    // --- Funções Auxiliares de HTML ---

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function handlePatdExists(duplicataData) {
        return `
            <div class="resultado-item alert alert-warning">
                <h4>PATD Duplicada</h4>
                <p>Já existe uma PATD similar (Nº ${duplicataData.numero_patd}) para o militar <strong>${escapeHtml(duplicataData.nome_militar)}</strong>.</p>
                <div class="prompt-actions">
                    <a href="${duplicataData.url}" class="btn btn-sm btn-secondary">Ver PATD Existente</a>
                </div>
            </div>
        `;
    }

    // --- NOVA FUNÇÃO: Militar Não Encontrado com Search Bar ---
    function handleMilitarNotFound(militarData, index) {
        const formId = `create-militar-form-${index}`;
        const searchInputId = `search-militar-${index}`;
        const searchResultsId = `search-results-${index}`;
        
        // Converte objeto para string para passar no data attribute
        const transgressaoJson = JSON.stringify(militarData).replace(/'/g, "&apos;");
        
        return `
            <div class="militar-nao-encontrado resultado-item">
                <h4>Militar Não Encontrado</h4>
                <p>O militar <strong>${escapeHtml(militarData.nome_completo_sugerido)}</strong> não foi encontrado.</p>
                
                <div class="search-wrapper">
                    <input type="text" 
                           class="search-input dynamic-search" 
                           id="${searchInputId}" 
                           data-index="${index}" 
                           data-meta='${transgressaoJson}'
                           placeholder="Pesquisar militar existente (Ex: Alesson)..." autocomplete="off">
                    <div class="search-results-dropdown" id="${searchResultsId}"></div>
                </div>

                <div class="divisor-ou">OU CADASTRAR NOVO</div>

                <p style="font-size: 0.9em; margin-bottom: 10px;">Se o militar não existe no banco, preencha abaixo:</p>

                <form id="${formId}" class="model-form create-militar-dynamic-form" data-index="${index}">
                    <input type="hidden" name="transgressao" value="${escapeHtml(militarData.transgressao || '')}">
                    <input type="hidden" name="data_ocorrencia" value="${escapeHtml(militarData.data_ocorrencia || '')}">
                    <input type="hidden" name="protocolo_comaer" value="${escapeHtml(militarData.protocolo_comaer || '')}">
                    <input type="hidden" name="oficio_transgressao" value="${escapeHtml(militarData.oficio_transgressao || '')}">
                    <input type="hidden" name="data_oficio" value="${escapeHtml(militarData.data_oficio || '')}">

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-sm">Cadastrar e Criar PATD</button>
                    </div>
                    <div class="dynamic-form-feedback" style="margin-top: 10px;"></div>
                </form>
            </div>
        `;
    }

    // --- Lógica da Search Bar (Debounce e Eventos) ---

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Listener global para inputs de busca dinâmica
    document.body.addEventListener('input', debounce(function(e) {
        if (e.target.classList.contains('dynamic-search')) {
            const query = e.target.value;
            const index = e.target.dataset.index;
            const resultsBox = document.getElementById(`search-results-${index}`);
            let metaDataStr = e.target.dataset.meta;
            
            if (query.length < 2) {
                resultsBox.style.display = 'none';
                return;
            }

            const formData = new FormData();
            formData.append('action', 'search_militar');
            formData.append('term', query);

            fetch("{% url 'Ouvidoria:index' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                resultsBox.innerHTML = '';
                if (data.results && data.results.length > 0) {
                    resultsBox.style.display = 'block';
                    data.results.forEach(militar => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.innerHTML = `
                            <span>${escapeHtml(militar.nome_guerra)} <small>(${escapeHtml(militar.nome_completo)})</small></span>
                            <small>SARAM: ${militar.saram || 'N/A'}</small>
                        `;
                        item.addEventListener('click', () => {
                            try {
                                const metaData = JSON.parse(metaDataStr);
                                associarMilitarExistente(militar.id, metaData, index);
                            } catch(err) {
                                console.error("Erro ao parsear metadata", err);
                            }
                        });
                        resultsBox.appendChild(item);
                    });
                } else {
                    resultsBox.style.display = 'block';
                    resultsBox.innerHTML = '<div class="search-item" style="cursor: default; color: #888;">Nenhum militar encontrado.</div>';
                }
            })
            .catch(err => console.error("Erro na busca:", err));
        }
    }, 400));

    // Fecha dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-wrapper')) {
            document.querySelectorAll('.search-results-dropdown').forEach(el => el.style.display = 'none');
        }
    });

    function associarMilitarExistente(militarId, transgressaoData, index) {
        const feedbackContainer = document.querySelector(`#create-militar-form-${index} .dynamic-form-feedback`);
        const searchInput = document.getElementById(`search-militar-${index}`);
        const resultsBox = document.getElementById(`search-results-${index}`);
        
        searchInput.disabled = true;
        resultsBox.style.display = 'none';
        feedbackContainer.innerHTML = '<div class="alert alert-info">⌛ Vinculando PATD ao militar selecionado...</div>';

        const formData = new FormData();
        formData.append('action', 'associate_patd');
        formData.append('militar_id', militarId);
        
        for (const key in transgressaoData) {
            formData.append(key, transgressaoData[key]);
        }

        fetch("{% url 'Ouvidoria:index' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            const container = document.querySelector(`#create-militar-form-${index}`).parentElement;
            if (data.status === 'success') {
                container.innerHTML = `<div class="alert alert-success">✅ PATD criada e vinculada com sucesso ao militar <strong>${escapeHtml(data.militar_nome)}</strong>!</div>`;
            } else {
                feedbackContainer.innerHTML = `<div class="alert alert-error">❌ Erro ao vincular: ${data.message}</div>`;
                searchInput.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            feedbackContainer.innerHTML = `<div class="alert alert-error">❌ Erro de conexão.</div>`;
            searchInput.disabled = false;
        });
    }

    // --- Submissão de Formulários Dinâmicos (Criar Novo) ---
    analiseBox.addEventListener('submit', function(e) {
        if (e.target && e.target.classList.contains('create-militar-dynamic-form')) {
            e.preventDefault();
            const form = e.target;
            const index = form.dataset.index;
            const createBtn = form.querySelector('button[type="submit"]');
            const feedbackContainer = form.querySelector('.dynamic-form-feedback');

            createBtn.textContent = 'Aguarde...';
            createBtn.disabled = true;
            feedbackContainer.innerHTML = '';

            const militarFormData = new FormData(form);
            militarFormData.append('action', 'create_militar_and_patd');

            fetch("{% url 'Ouvidoria:index' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: new URLSearchParams(militarFormData)
            })
            .then(response => response.json())
            .then(data => {
                const formContainer = form.parentElement;
                if (data.status === 'success') {
                    formContainer.innerHTML = `<div class="alert alert-success">✅ ${escapeHtml(data.message)}</div>`;
                } else {
                    let errorMsg = "Não foi possível cadastrar o militar.";
                    if (data.errors) {
                         try {
                             const errors = JSON.parse(data.errors);
                             const firstFieldName = Object.keys(errors)[0];
                             if(errors[firstFieldName] && errors[firstFieldName][0] && (errors[firstFieldName][0].message || errors[firstFieldName][0])){
                                 errorMsg += ` (${escapeHtml(errors[firstFieldName][0].message || errors[firstFieldName][0])})`;
                             }
                         } catch (parseError) {
                             errorMsg += ` (Detalhe: ${escapeHtml(data.errors)})`;
                         }
                    } else if (data.message) {
                        errorMsg = data.message;
                    }
                    feedbackContainer.innerHTML = `<div class="alert alert-error">❌ ${escapeHtml(errorMsg)}</div>`;
                    createBtn.textContent = 'Cadastrar e Criar PATD';
                    createBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedbackContainer.innerHTML = `<div class="alert alert-error">❌ Ocorreu um erro de comunicação.</div>`;
                createBtn.textContent = 'Cadastrar e Criar PATD';
                createBtn.disabled = false;
            });
        }
    });

    // --- Event Listener do Botão de Upload ---
    submitButton.addEventListener('click', () => {
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Por favor, selecione um ficheiro PDF antes de analisar.');
            return;
        }
        if (fileInput.files[0].type !== "application/pdf") {
            alert('Apenas ficheiros PDF são permitidos!');
            return;
        }

        const formData = new FormData();
        formData.append('pdf_file', fileInput.files[0]);
        formData.append('action', 'analyze');

        setUIState(true);

        fetch("{% url 'Ouvidoria:index' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                 return response.json().catch(() => {
                    return response.text().then(text => {
                        throw new Error(`Erro ${response.status}: ${text.substring(0, 500)}`);
                    });
                }).then(errorData => {
                      throw new Error(errorData.message || errorData.detail || `Erro ${response.status}`);
                 });
            }
            return response.json();
        })
        .then(data => {
            let htmlResult = '';
            if (data.status === 'processed') {
                htmlResult += '<h3>Resultado da Análise</h3>';
                let hasContent = false;

                if (data.patds_criadas && data.patds_criadas.length > 0) {
                    data.patds_criadas.forEach(patd => {
                        htmlResult += `<div class="resultado-item alert alert-success">✅ PATD Nº ${patd.numero_patd} criada com sucesso para <strong>${escapeHtml(patd.nome_militar)}</strong>.</div>`;
                    });
                    hasContent = true;
                }
                if (data.militares_nao_encontrados && data.militares_nao_encontrados.length > 0) {
                    data.militares_nao_encontrados.forEach((militar, index) => {
                        htmlResult += handleMilitarNotFound(militar, index);
                    });
                    hasContent = true;
                }
                if (data.duplicatas_encontradas && data.duplicatas_encontradas.length > 0) {
                    data.duplicatas_encontradas.forEach(dup => {
                        htmlResult += handlePatdExists(dup);
                    });
                    hasContent = true;
                }

                if (!hasContent) {
                     htmlResult += '<p class="alert alert-info">A análise foi concluída, mas nenhuma ação foi identificada.</p>';
                }
                displayResult(htmlResult);
            } else if (data.status === 'error') {
                 displayResult(`<h3 style="color: var(--danger-color);">Erro na Análise</h3><p>${escapeHtml(data.message || 'Erro desconhecido.')}</p>`);
            } else {
                 displayResult(`<h3 style="color: var(--danger-color);">Erro Inesperado</h3><p>O servidor retornou uma resposta inesperada.</p>`);
            }
        })
        .catch(error => {
            console.error('Erro no fetch:', error);
            const errorMessage = (error && error.message) ? String(error.message) : 'Erro inesperado.';
            displayResult(`<h3 style="color: var(--danger-color);">Erro na Análise</h3><p>${escapeHtml(errorMessage)}</p>`);
        })
        .finally(() => {
            setUIState(false);
        });
    });

    function setUIState(isSubmitting) {
        const spinner = submitButton.querySelector('.spinner');
        const buttonText = submitButton.querySelector('.button-text');
        if (isSubmitting) {
            buttonText.textContent = 'A analisar...';
            spinner.style.display = 'inline-block';
            submitButton.disabled = true;
            analiseBox.innerHTML = `<div class="loading-state"><div class="big-spinner"></div><p>A processar o documento...<br>Isto pode levar alguns segundos.</p></div>`;
        } else {
            buttonText.textContent = 'Analisar e Criar PATD';
            spinner.style.display = 'none';
            submitButton.disabled = false;
        }
    }

    function displayResult(htmlContent) {
        analiseBox.innerHTML = htmlContent;
    }
});
</script>
{% endblock %}